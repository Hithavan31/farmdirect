<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farmer Orders - FarmDirect</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fafafa;
      margin: 0;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      color: #333;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      background: #667eea;
      color: white;
      transition: all 0.3s;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-warning {
      background: #f39c12;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-secondary {
      background: #95a5a6;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 32px;
      color: #667eea;
    }

    .stat-card p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    .order-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 5px solid #667eea;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .order-card.pending {
      border-left-color: #f39c12;
    }

    .order-card.confirmed {
      border-left-color: #3498db;
    }

    .order-card.delivered {
      border-left-color: #27ae60;
    }

    .order-card.cancelled {
      border-left-color: #e74c3c;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .order-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-delivered {
      background: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .order-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .order-actions button {
      flex: 1;
      padding: 8px 15px;
      font-size: 14px;
    }

    .no-orders {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .no-orders h2 {
      margin: 0 0 10px 0;
      color: #666;
    }

    .error {
      color: #e74c3c;
      padding: 10px;
      background: #fee;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }

    .success {
      color: #27ae60;
      padding: 10px;
      background: #efe;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 10px 20px;
      border: 2px solid #ddd;
      background: white;
      color: #666;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .filter-tab:hover {
      border-color: #667eea;
    }

    .filter-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .payment-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }

    .payment-upi {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .payment-cod {
      background: #fff3e0;
      color: #e65100;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>üì¶ Order Management</h1>
  <div class="nav-buttons">
    <button onclick="goToDashboard()">Back to Dashboard</button>
    <button onclick="logout()" class="btn-danger">Logout</button>
  </div>
</div>

<div class="error" id="error-msg"></div>
<div class="success" id="success-msg"></div>

<div class="stats-grid">
  <div class="stat-card">
    <h3 id="total-orders">0</h3>
    <p>Total Orders</p>
  </div>
  <div class="stat-card">
    <h3 id="pending-orders">0</h3>
    <p>Pending Orders</p>
  </div>
  <div class="stat-card">
    <h3 id="total-revenue">‚Çπ0</h3>
    <p>Total Revenue</p>
  </div>
</div>

<div class="filter-tabs">
  <button class="filter-tab active" onclick="filterOrders('all')">All Orders</button>
  <button class="filter-tab" onclick="filterOrders('pending')">Pending</button>
  <button class="filter-tab" onclick="filterOrders('confirmed')">Confirmed</button>
  <button class="filter-tab" onclick="filterOrders('delivered')">Delivered</button>
  <button class="filter-tab" onclick="filterOrders('cancelled')">Cancelled</button>
</div>

<h2>Received Orders</h2>
<div id="orders-container">
  <div class="loading">Loading orders...</div>
</div>

<script>
// Get auth data from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const authToken = urlParams.get('token');
const userRole = urlParams.get('role');
const userId = urlParams.get('userId');

console.log('Auth data:', { 
  token: authToken ? 'Present' : 'Missing', 
  role: userRole, 
  userId: userId 
});

// Check authentication
if (!authToken || userRole !== 'farmer') {
  alert("Unauthorized access. Please login as a farmer.");
  window.location.href = "login.html";
}

let allOrders = [];
let currentFilter = 'all';

function showError(message) {
  const errorEl = document.getElementById('error-msg');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  document.getElementById('success-msg').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
  console.error('Error:', message);
}

function showSuccess(message) {
  const successEl = document.getElementById('success-msg');
  successEl.textContent = message;
  successEl.style.display = 'block';
  document.getElementById('error-msg').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
  console.log('Success:', message);
}

async function loadOrders() {
  console.log('=== Loading Farmer Orders ===');
  console.log('Token:', authToken ? authToken.substring(0, 20) + '...' : 'MISSING');
  
  try {
    const res = await fetch('http://localhost:3000/orders/farmer', {
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });

    console.log('Response status:', res.status);

    if (!res.ok) {
      const errorData = await res.json();
      console.error('Error response:', errorData);
      throw new Error(errorData.error || 'Failed to load orders');
    }

    allOrders = await res.json();
    console.log('Orders loaded successfully:', allOrders.length);
    console.log('Orders data:', allOrders);
    
    updateStats();
    displayOrders();
  } catch (error) {
    console.error('Load orders error:', error);
    showError('Failed to load orders: ' + error.message);
    document.getElementById('orders-container').innerHTML = `
      <div class="no-orders">
        <h2>‚ùå Error Loading Orders</h2>
        <p>${error.message}</p>
        <p style="font-size: 14px; color: #999;">Check browser console for details (F12)</p>
      </div>
    `;
  }
}

function updateStats() {
  const totalOrders = allOrders.length;
  const pendingOrders = allOrders.filter(o => (o.status || 'pending') === 'pending').length;
  const totalRevenue = allOrders
    .filter(o => (o.status || 'pending') === 'delivered')
    .reduce((sum, o) => sum + (o.totalAmount || 0), 0);

  document.getElementById('total-orders').textContent = totalOrders;
  document.getElementById('pending-orders').textContent = pendingOrders;
  document.getElementById('total-revenue').textContent = '‚Çπ' + totalRevenue.toFixed(2);
}

function displayOrders() {
  const container = document.getElementById('orders-container');
  
  let filteredOrders = allOrders;
  if (currentFilter !== 'all') {
    filteredOrders = allOrders.filter(o => (o.status || 'pending') === currentFilter);
  }

  if (filteredOrders.length === 0) {
    container.innerHTML = `
      <div class="no-orders">
        <h2>üì≠ No ${currentFilter === 'all' ? '' : currentFilter} orders yet</h2>
        <p>Orders will appear here when retailers place them</p>
      </div>
    `;
    return;
  }

  container.innerHTML = '';

  filteredOrders.forEach(order => {
    // Safe property access with defaults
    const orderDate = order.orderDate || new Date();
    const date = new Date(orderDate).toLocaleString('en-IN');
    const status = order.status || 'pending';
    const statusClass = `status-${status}`;
    const farmerName = order.farmerName || 'Unknown';
    const totalAmount = order.totalAmount || 0;
    const items = order.items || [];
    const deliveryAddress = order.deliveryAddress || 'N/A';
    const contactNumber = order.contactNumber || 'N/A';
    const courierService = order.courierService || 'standard';
    const paymentMethod = order.paymentMethod || 'cod';
    const upiTransactionId = order.upiTransactionId || '';
    const notes = order.notes || '';
    const orderId = order._id ? order._id.slice(-6).toUpperCase() : 'N/A';
    
    const div = document.createElement('div');
    div.className = `order-card ${status}`;
    div.innerHTML = `
      <div class="order-header">
        <div>
          <h3 style="margin: 0 0 5px 0;">Order #${orderId}</h3>
          <span class="order-status ${statusClass}">${status.toUpperCase()}</span>
          <span class="payment-badge payment-${paymentMethod}">${paymentMethod.toUpperCase()}</span>
          <p style="margin: 10px 0 0 0; color: #999; font-size: 13px;">${date}</p>
        </div>
        <div style="text-align: right;">
          <strong style="font-size: 24px; color: #667eea;">‚Çπ${totalAmount}</strong>
        </div>
      </div>

      <div class="order-details">
        <p><strong>üõí Items Ordered:</strong></p>
        <ul style="margin: 5px 0; padding-left: 20px;">
          ${items.map(item => `
            <li>${item.produceName || 'Unknown'} - ${item.quantity || 0} units @ ‚Çπ${item.price || 0} each</li>
          `).join('')}
        </ul>
      </div>

      <p><strong>üìç Delivery Address:</strong> ${deliveryAddress}</p>
      <p><strong>üìû Retailer Contact:</strong> ${contactNumber}</p>
      <p><strong>üë§ Retailer Name:</strong> ${order.retailerName || 'Not provided'}</p>
      <p><strong>üöö Courier Preference:</strong> ${courierService}</p>
      
      ${paymentMethod === 'upi' && upiTransactionId ? 
        `<p><strong>üí≥ UPI Transaction ID:</strong> ${upiTransactionId}</p>` : ''}
      
      ${notes ? 
        `<p><strong>üìù Customer Notes:</strong> ${notes}</p>` : ''}

      <div class="order-actions">
        ${status === 'pending' ? `
          <button class="btn-success" onclick="updateOrderStatus('${order._id}', 'confirmed')">
            ‚úì Confirm Order
          </button>
          <button class="btn-danger" onclick="updateOrderStatus('${order._id}', 'cancelled')">
            ‚úó Cancel Order
          </button>
        ` : ''}
        
        ${status === 'confirmed' ? `
          <button class="btn-success" onclick="updateOrderStatus('${order._id}', 'delivered')">
            ‚úì Mark as Delivered
          </button>
        ` : ''}
        
        ${status === 'delivered' ? `
          <button disabled style="opacity: 0.6; cursor: not-allowed;">
            ‚úì Order Completed
          </button>
        ` : ''}
        
        ${status === 'cancelled' ? `
          <button disabled style="opacity: 0.6; cursor: not-allowed; background: #e74c3c;">
            ‚úó Order Cancelled
          </button>
        ` : ''}
      </div>
    `;
    
    container.appendChild(div);
  });
}

async function updateOrderStatus(orderId, newStatus) {
  const confirmMessages = {
    confirmed: 'Are you sure you want to confirm this order?',
    delivered: 'Are you sure you want to mark this order as delivered?',
    cancelled: 'Are you sure you want to cancel this order?'
  };

  if (!confirm(confirmMessages[newStatus])) {
    return;
  }

  console.log('Updating order:', orderId, 'to status:', newStatus);

  try {
    const res = await fetch(`http://localhost:3000/orders/${orderId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ status: newStatus })
    });

    console.log('Update response status:', res.status);
    const data = await res.json();
    console.log('Update response data:', data);

    if (res.ok) {
      showSuccess(`Order ${newStatus} successfully!`);
      loadOrders(); // Reload orders
    } else {
      showError(data.error || 'Failed to update order status');
    }
  } catch (error) {
    console.error('Update order error:', error);
    showError('Network error: ' + error.message);
  }
}

function filterOrders(status) {
  currentFilter = status;
  
  // Update active tab
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  displayOrders();
}

function goToDashboard() {
  const params = new URLSearchParams({
    token: authToken,
    role: userRole,
    userId: userId
  });
  window.location.href = 'farmers.html?' + params.toString();
}

function logout() {
  if (confirm("Are you sure you want to logout?")) {
    window.location.href = "login.html";
  }
}

// Load orders on page load
console.log('Page loaded, starting to load orders...');
loadOrders();

// Auto-refresh every 30 seconds
setInterval(() => {
  console.log('Auto-refreshing orders...');
  loadOrders();
}, 30000);
</script>

</body>
</html>